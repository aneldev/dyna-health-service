{"version":3,"sources":["webpack://dyna-health-service/webpack/universalModuleDefinition","webpack://dyna-health-service/webpack/bootstrap","webpack://dyna-health-service/./dyna/universalImport.ts","webpack://dyna-health-service/./src/DynaHealthService.ts","webpack://dyna-health-service/./src/interfaces.ts","webpack://dyna-health-service/./src/node.ts","webpack://dyna-health-service/external \"dyna-node/node\""],"names":[],"mappings":"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","file":"node.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"dyna-health-service\", [], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"dyna-health-service\"] = factory();\n\telse\n\t\troot[\"dyna-health-service\"] = factory();\n})(global, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/node.ts\");\n","export const importUniversal = <TModule>(moduleName: string): TModule => {\n  const universalImports =\n    (typeof process !== \"undefined\" && (process as any).universalImports) ||\n    (typeof window !== \"undefined\" && (window as any).universalImports);\n\n  if (!universalImports) {\n    console.error(`importUniversal error: no exports found, use exportUniversalNode/exportUniversalWeb to export universal modules`);\n  }\n\n  const runningEnvironment: string =\n    process && (process as any).universalImports\n      ? \"node\"\n      : \"web\";\n\n  if (!universalImports[moduleName]) {\n    console.error(`importUniversal error: module [${moduleName}] not found, seems that is not exported for running Environment [${runningEnvironment}]`);\n  }\n\n  return universalImports[moduleName];\n};\n\nexport const exportNode = (modules: { [moduleName: string]: any }): void => {\n  (process as any).universalImports = {\n    ...((process as any).universalImports || {}),\n    ...modules,\n  };\n};\n\n\nexport const exportWeb = (modules: { [moduleName: string]: any }): void => {\n  (window as any).universalImports = {\n    ...((window as any).universalImports || {}),\n    ...modules,\n  };\n};\n\n","import {IError} from \"dyna-interfaces\";\nimport {\n  DynaNodeService, IDynaNodeServiceCommandConfig,\n  DynaNodeMessageT,\n} from \"dyna-node/node\";\n\nimport {importUniversal} from \"../dyna/universalImport\";\n\nimport {\n  IInstanceStats,\n\n  COMMAND_addHealthStats,\n  ICOMMAND_addHealthStats_data,\n\n  COMMAND_registerNotificationHealthStats,\n  ICOMMAND_healthStatsUpdate_data,\n\n  COMMAND_healthStatsUpdate,\n\n  COMMAND_unregisterNotificationHealthStats,\n} from \"./interfaces\";\n\nexport interface IDynaHealthServiceConfig {\n  parallelRequests?: number;\n  serviceRegistration: {\n    serverDynaNodeAddress: string;\n    serviceConnectionId: string;\n    encryptionKey: string;\n    accessKey: string;\n    requestExpirationInMinutes?: number;\n  };\n}\n\ninterface IListener {\n  address: string;\n  replyOfId: string;\n}\n\nexport class DynaHealthService {\n  private readonly service: DynaNodeService;\n  private listeners: IListener[] = [];\n\n  constructor(private readonly config: IDynaHealthServiceConfig) {\n    this.service = new (importUniversal<typeof DynaNodeService>(\"DynaNodeService\"))({\n      ...this.config,\n\n      onCommand: {\n        [COMMAND_addHealthStats]: {\n          execute: ({message, next}) => {\n            this.pushNotification(message.data);\n            next();\n          },\n        } as IDynaNodeServiceCommandConfig<null, ICOMMAND_addHealthStats_data>,\n        [COMMAND_registerNotificationHealthStats]: {\n          execute: ({message, next}) => {\n            this.registerListener({\n              address: message.from,\n              replyOfId: message.id,\n            });\n            next();\n          },\n        } as IDynaNodeServiceCommandConfig<null, null>,\n        [COMMAND_unregisterNotificationHealthStats]: {\n          execute: ({message, next}) => {\n            this.unregisterListener({\n              address: message.from,\n              replyOfId: message.id,\n            });\n            next();\n          },\n        } as IDynaNodeServiceCommandConfig<null, null>\n      },\n\n      onReplySendFail: (message: DynaNodeMessageT<any, any>, error: any, retry: () => void, skip: () => void, stop: () => void) => {\n        console.error(`${this.service.friendlyName}/onReplySendFail`, 'Cannot send this reply, message will be skipped (will be lost)', {message, error});\n        skip();\n      },\n\n      onServiceRegistrationFail: (error: IError) => {\n        console.error(`${this.service.friendlyName}/onServiceRegistrationFail`, 'Service registration failed', {error});\n      },\n\n      onMessageQueueError: (error: IError) => {\n        console.error(`${this.service.friendlyName}/onMessageQueueError`, 'Message Queue error (disk error?)', {error});\n      },\n\n    });\n  }\n\n  public start(): Promise<void> {\n    return this.service.start()\n      .then(() => {\n        console.log(`DynaTravelHealthService ${this.service.friendlyName} started`);\n      })\n      .catch((error: IError) => {\n        console.error(`DynaTravelHealthService ${this.service.friendlyName} cannot start`, error);\n      });\n  }\n\n  public get active(): boolean {\n    return this.service.active;\n  }\n\n  public stop(): Promise<void> {\n    return this.service.stop();\n  }\n\n  public registerListener(listener: IListener): void {\n    this.listeners.push(listener);\n  }\n\n  public unregisterListener(listener: IListener): void {\n    this.listeners = this.listeners.filter(scanListener => scanListener.replyOfId !== listener.replyOfId)\n  }\n\n  private pushNotification(stats: IInstanceStats): void {\n    this.listeners.forEach(listener => {\n      this.service.sendReceive<null, ICOMMAND_healthStatsUpdate_data, null, null>({\n        to: listener.address,\n        replyOfId: listener.replyOfId,\n        command: COMMAND_healthStatsUpdate,\n        data: {stats},\n        replyTimeoutInMs: 5000,\n      })\n        .catch((error: IError) => {\n          if (error.code === 404.101 || error.code === 1810211741) {\n            this.unregisterListener(listener);\n          }\n          else {\n            console.warn(`DynaTravelHealthService cannot sent to listener`, {\n              listener,\n              error,\n            });\n          }\n        })\n    });\n  }\n\n}\n","import {IMemoryStats} from \"dyna-memory-stats\";\n\nexport const enum EInstanceType {\n  APP = \"APP\",\n  STANDALONE_SERVICE = \"STANDALONE_SERVICE\",\n  MASTER_SERVICE = \"MASTER_SERVICE\",\n  WORKER_SERVICE = \"WORKER_SERVICE\",\n}\n\nexport interface IInstanceStats {\n  id: string;\n  time: number; // Date\n  serviceType: EInstanceType;\n  memoryStats: IMemoryStats;\n  availabilityIndex: number;\n  completedWorkload: number;\n}\n\n/*\n* Add health stats.\n* This is used for commands, to update the services with some stats of it.\n* Send the COMMAND_addHealthStats with ICOMMAND_addHealthStats_data and that's all.\n* */\n\nexport const COMMAND_addHealthStats: string = \"COMMAND_addHealthStats\";\nexport interface ICOMMAND_addHealthStats_data extends IInstanceStats {}\n\n/*\n* Monitor the stats\n* Register your self, simply send a message with command COMMAND_registerNotificationHealthStats\n* without args or data. You will start receiving multiple replies with command COMMAND_healthStatsUpdate\n* and ICOMMAND_healthStatsUpdate_data as data.\n*\n* You have to reply on each receive a blank email to let the service know that you are alive.\n* Simply call `dynaNodeClient.reply(message)` where message is the incomming message with the stats.\n* If you don't reply withing 5secs the service will unregister you. You have to resend the\n* COMMAND_registerNotificationHealthStats command.\n*\n* Sending this command, apply a timeout with replyTimeoutInMs, for instance 10000.\n* If in 10secs you don't a response from the service then the connection is lost.\n* You have to resend the command and start from the beginning.\n* Resuming the data flow from the last received point is not currently supported.\n* */\n\nexport const COMMAND_registerNotificationHealthStats: string = \"COMMAND_registerNotificationHealthStats\";\n\nexport const COMMAND_healthStatsUpdate: string = \"COMMAND_healthStatsUpdate\"; // note: you should reply a blank message as acknowledge\nexport interface ICOMMAND_healthStatsUpdate_data {\n  stats: IInstanceStats,\n}\n\nexport const COMMAND_unregisterNotificationHealthStats: string = \"COMMAND_unregisterNotificationHealthStats\";\n","import {exportNode} from \"../dyna/universalImport\";\n\nimport {DynaNodeService} from \"dyna-node/node\";\n\nexportNode({\n  DynaNodeService,\n});\n\nexport * from \"./interfaces\";\nexport * from \"./DynaHealthService\";\n","module.exports = require(\"dyna-node/node\");"],"sourceRoot":""}